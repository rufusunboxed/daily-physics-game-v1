<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Today’s Physics Game</title>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<style>
  :root{
    --green:#009901; --red:#FF0000; --light:#F0F0F0; --orange:#FF9700; --ink:#111;
  }
  html,body{margin:0;background:#fff;color:var(--ink)}
  body{font-family:"Century Gothic","Apple Gothic","Segoe UI",Arial,sans-serif;font-size:20px;line-height:1.5}
  .wrap{max-width:940px;margin:0 auto;padding:24px 0;display:flex;justify-content:center}
  .card{width:100%;max-width:760px;background:var(--light);border:2px solid var(--orange);border-radius:20px;box-sizing:border-box}
  /* Frame 1 */
  #preplay{text-align:center;position:relative}
  .dateTop{font-size:12px;margin-top:30px;margin-bottom:5px}
  .title24{font-weight:700;font-size:24px;margin:0}
  .previewBox{width:calc(100% - 80px);margin:30px auto 0;background:#fff;border-radius:20px;padding:20px;box-sizing:border-box;font-size:18px}
  .btnPlay{width:87px;height:36px;margin:30px auto 30px auto;background:var(--orange);color:#000;border-radius:5px;border:0;cursor:pointer;font-weight:700;font-size:18px}
  .btnPlay:hover{filter:brightness(0.95)}
  /* In-game */
  #game{padding:30px;display:none}
  .dateLeft{font-size:12px}
  .sentence{font-size:18px;text-align:left;margin-top:20px;line-height:1.8}
  .blank{
    display:inline-flex;align-items:center;justify-content:center;
    width:118px;height:32px;box-sizing:border-box;
    border:1px solid var(--orange);border-radius:5px;background:#fff;
    margin:0 4px 6px 4px;padding:0 8px;cursor:grab;vertical-align:middle;
  }
  .blank.used{border-color:#000}
  .blank.correct{border-color:var(--green);color:#000}
  .blank.incorrect{border-color:var(--red);color:#000}
  .bank{display:flex;flex-wrap:wrap;gap:10px;justify-content:flex-start;margin-top:20px}
  .chip{
    min-width:84px;height:26px;padding:0 10px;box-sizing:border-box;
    display:inline-flex;align-items:center;justify-content:center;
    border:1px dashed #000;border-radius:5px;background:#fff;
    cursor:grab;font-size:12px;line-height:12px;white-space:nowrap
  }
  .chip:hover{background:#f7f7f7}
  .controls{display:flex;flex-wrap:wrap;gap:20px;justify-content:flex-start;margin-top:30px}
  .btn{width:87px;height:32px;border-radius:5px;border:1px solid #000;background:#fff;color:#000;font-weight:700;font-size:18px;cursor:pointer}
  .btn:hover{background:#f7f7f7}
  .btnCheck{background:var(--orange);border-color:var(--orange)}
  .btnCheck:hover{filter:brightness(0.95)}
  .btnGreat{width:131px;height:32px;background:var(--green);border-color:var(--green);color:#fff;font-weight:400;font-size:16px;cursor:default}
  .btnLink{width:313px;height:32px;background:#fff;border:1px solid #000;border-radius:5px;color:#000;font-size:16px;font-weight:400;text-decoration:none;display:inline-flex;align-items:center;justify-content:center;opacity:0;transform:translateX(12px)}
  .btnLink:hover{background:#f7f7f7}
  .hidden{display:none}

  /* Animations */
  @keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.05)}100%{transform:scale(1)}}
  @keyframes slideOutRight{to{transform:translateX(24px);opacity:0}}
  @keyframes slideInRight{to{transform:translateX(0);opacity:1}}
  .pulse{animation:pulse .6s ease-in-out 2}
  .slideOutRight{animation:slideOutRight .35s ease-out forwards}
  .slideInRightStart{opacity:0;transform:translateX(12px)}
  .slideInRight{animation:slideInRight .35s ease-out forwards}

  /* Confetti */
  .confetti{position:fixed;left:50%;top:20%;width:6px;height:10px;background:var(--green);border-radius:1px;opacity:.9;animation:fall .9s ease-out forwards}
  @keyframes fall{from{transform:translate(-50%,0) rotate(0)}to{transform:translate(calc(-50% + var(--dx)),120px) rotate(260deg);opacity:0}}

  @media(max-width:800px){
    .card{max-width:95%}
    .previewBox{width:calc(100% - 40px)}
    .btnLink{width:100%}
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <section id="preplay">
      <div class="dateTop" id="dateTop">Loading…</div>
      <h1 class="title24">Today’s Physics Game</h1>
      <div class="previewBox" id="previewBox">Loading question…</div>
      <button class="btnPlay" id="playBtn">Play</button>
    </section>

    <section id="game">
      <div class="dateLeft" id="dateLeft">—</div>
      <div class="sentence" id="sentence"></div>
      <div class="bank" id="bank"></div>
      <div class="controls">
        <button class="btn" id="resetBtn">Reset</button>
        <button class="btn btnCheck" id="checkBtn">Check</button>
        <button class="btn btnGreat hidden" id="greatBtn">Great Job!</button>
        <a class="btnLink slideInRightStart hidden" id="learnBtn" target="_blank" rel="noopener">Learn more about this topic here</a>
      </div>
    </section>

    <section id="empty" class="hidden" style="padding:30px;text-align:center">No question found for today.</section>
  </div>
</div>

<script>
const CSV_URL="https://docs.google.com/spreadsheets/d/e/2PACX-1vSJlHGcShI4Ek9XrNBx_-xD7CT7uS2K2lhmzr1WU6z48u0xNcncL0RGfYFSzzPkTUZ-yurB7L0x7Szk/pub?gid=0&single=true&output=csv";
let S={q:"",correct:[],distr:[],blanks:0,placements:[],tokens:[],chipsMap:new Map(),link:""};
let _drag=null;

function $(q){return document.querySelector(q)}
function splitList(s){return (s||"").split(",").map(x=>x.trim()).filter(Boolean)}
function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a}
function toYMD(){const d=new Date(),p=new Intl.DateTimeFormat('en-CA',{timeZone:'Europe/London',year:'numeric',month:'2-digit',day:'2-digit'}).format(d).split('-');return `${p[0]}-${p[1]}-${p[2]}`}
function human(){const d=new Date(),parts=new Intl.DateTimeFormat('en-GB',{timeZone:'Europe/London',day:'numeric',month:'long',year:'numeric'}).formatToParts(d);const day=+parts.find(p=>p.type==='day').value;const mon=parts.find(p=>p.type==='month').value;const y=parts.find(p=>p.type==='year').value;const s=["th","st","nd","rd"],v=day%100;return `${day+(s[(v-20)%10]||s[v]||s[0])} ${mon} ${y}`}

function renderPreview(){ $("#previewBox").textContent=S.q.replace(/\[blank\]/g,"______"); }

function enableBlank(b){
  b.addEventListener("dragover",e=>e.preventDefault());
  b.addEventListener("drop",e=>{
    e.preventDefault();
    const idx=+b.dataset.index;
    const id=e.dataTransfer.getData("text/id");
    const word=e.dataTransfer.getData("text/label");
    if(!id) return;
    if(S.placements[idx]) returnChipToBank(S.placements[idx].id);
    if(_drag && _drag.from==="blank"){S.placements[_drag.idx]=null;const el=document.querySelector(`.blank[data-index="${_drag.idx}"]`);el.textContent="";el.className="blank";}
    if(_drag && _drag.from==="bank"){const node=S.chipsMap.get(id);if(node && node.parentElement) node.parentElement.removeChild(node);}
    S.placements[idx]={id,word};
    b.textContent=word; b.className="blank used"; _drag=null;
  });
  b.addEventListener("click",()=>{
    if(b.textContent.trim()){ // send back to bank
      const idx=+b.dataset.index;
      returnChipToBank(S.placements[idx].id);
      S.placements[idx]=null;
      b.textContent=""; b.className="blank";
    }
  });
  b.draggable=true;
}

function renderSentence(){
  const host=$("#sentence"); host.innerHTML="";
  const parts=S.q.split("[blank]");
  parts.forEach((t,i)=>{
    host.append(document.createTextNode(t));
    if(i<parts.length-1){
      const sp=document.createElement("span");
      sp.className="blank"; sp.dataset.index=i;
      enableBlank(sp); host.append(sp);
    }
  });
}

let chipSeq=0;
function makeChip(word){
  const id=`c${++chipSeq}`;
  const chip=document.createElement("span");
  chip.className="chip"; chip.textContent=word; chip.draggable=true; chip.dataset.id=id;
  chip.addEventListener("dragstart",e=>{
    _drag={from:"bank",id,word,node:chip};
    e.dataTransfer.setData("text/id", id);
    e.dataTransfer.setData("text/label", word);
  });
  chip.addEventListener("click",()=>{
    const idx=S.placements.findIndex(p=>!p);
    if(idx>-1){const blank=document.querySelector(`.blank[data-index="${idx}"]`);
      if(blank){chip.parentElement.removeChild(chip);S.placements[idx]={id,word};blank.textContent=word;blank.className="blank used";}
    }
  });
  S.chipsMap.set(id, chip);
  return chip;
}

function returnChipToBank(id){const chip=S.chipsMap.get(id);if(chip && !$("#bank").contains(chip)) $("#bank").append(chip);}
function renderBank(){ $("#bank").innerHTML=""; S.tokens.forEach(tok=>$("#bank").append(makeChip(tok))); }

function checkAnswers(){
  let allCorrect=true;
  S.placements.forEach((p,i)=>{
    const b=document.querySelector(`.blank[data-index="${i}"]`);
    if(p && p.word===S.correct[i]){b.className="blank correct";}
    else {b.className="blank incorrect";allCorrect=false;}
  });
  if(allCorrect) showSuccess();
}

function showSuccess(){
  $("#checkBtn").classList.add("hidden");
  $("#greatBtn").classList.remove("hidden");
  $("#greatBtn").classList.add("pulse");
  setTimeout(()=>{$("#learnBtn").classList.remove("hidden");$("#learnBtn").classList.add("slideInRight");$("#learnBtn").href=S.link||"#";},1000);
  for(let i=0;i<20;i++){const c=document.createElement("div");c.className="confetti";c.style.setProperty("--dx",`${(Math.random()*200-100)}px`);c.style.background=Math.random()>.5?"var(--green)":"var(--orange)";document.body.append(c);setTimeout(()=>c.remove(),900);}
}

function resetGame(){
  $("#preplay").style.display="block";
  $("#game").style.display="none";
  $("#empty").classList.add("hidden");
  $("#checkBtn").classList.remove("hidden");
  $("#greatBtn").classList.add("hidden");
  $("#greatBtn").classList.remove("pulse");
  $("#learnBtn").classList.add("hidden");
  $("#learnBtn").classList.remove("slideInRight");
  $("#learnBtn").style.opacity=0;
  $("#learnBtn").style.transform="translateX(12px)";
}

$("#playBtn").onclick=()=>{
  $("#preplay").style.display="none";
  $("#game").style.display="block";
  $("#dateLeft").textContent=human();
  renderSentence(); renderBank();
};

$("#checkBtn").onclick=checkAnswers;
$("#resetBtn").onclick=resetGame;

Papa.parse(CSV_URL,{download:true,header:true,complete:(res)=>{
  const today=toYMD();
  const row=res.data.find(r=>r.date===today && r.type==="fill_blank");
  if(!row){$("#empty").classList.remove("hidden");$("#preplay").style.display="none";return;}
  S.q=row.question;
  S.correct=splitList(row.correct_words);
  S.distr=splitList(row.distractors);
  S.tokens=shuffle([...S.correct,...S.distr]);
  S.blanks=(S.q.match(/\[blank\]/g)||[]).length;
  S.placements=Array(S.blanks).fill(null);
  S.link=row.link||"";
  $("#dateTop").textContent=human();
  renderPreview();
}});
</script>
</body>
</html>
