<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Today’s Physics Game</title>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<style>
  :root{
    --green:#009901;
    --red:#FF0000;
    --light:#F0F0F0;
    --orange:#FF9700;
    --ink:#111;
    --chip-min:84px;
  }
  html,body{margin:0;background:#fff;color:var(--ink)}
  body{font-family:"Century Gothic","Apple Gothic","Segoe UI",Arial,sans-serif;font-size:20px;line-height:1.5}

  .wrap{max-width:940px;margin:0 auto;padding:16px;display:flex;justify-content:center}
  .card{width:100%;max-width:760px;background:var(--light);border:2px solid var(--orange);border-radius:20px;box-sizing:border-box}

  /* Frame 1 */
  #preplay{height:260px;text-align:center;position:relative}
  .dateTop{font-size:12px;margin-top:30px;margin-bottom:5px}
  .title24{font-weight:700;font-size:24px;margin:0}
  .previewBox{width:calc(100% - 80px);margin:30px auto 0;background:#fff;border-radius:20px;padding:20px;box-sizing:border-box;font-size:18px}
  .btnPlay{width:87px;height:36px;margin:30px auto 0;background:var(--orange);color:#000;border-radius:5px;border:0;cursor:pointer;font-weight:700;font-size:18px;transition:filter .15s,transform .05s}
  .btnPlay:hover{filter:brightness(.95)} .btnPlay:active{transform:scale(.98)}

  /* In-game */
  #game{padding:30px;display:none}
  .dateLeft{font-size:12px}
  .sentence{font-size:18px;text-align:left;margin-top:20px;line-height:32px}

  /* Fill-in blanks */
  .blank{
    display:inline-flex;vertical-align:middle;align-items:center;justify-content:center;
    min-width:118px;height:32px;line-height:32px;box-sizing:border-box;border:1px solid var(--orange);border-radius:5px;background:#fff;
    margin:0 4px 6px 4px;padding:0 8px;cursor:grab;white-space:nowrap;overflow:hidden;text-overflow:ellipsis
  }
  .blank.used{border-color:#000} .blank.correct{border-color:var(--green)} .blank.incorrect{border-color:var(--red)}

  /* MCQ answer slot (desktop: inline/narrow default; mobile: full width) */
  .answerSlot{
    display:inline-flex;align-items:center;gap:8px;
    text-align:left;font-size:14px;line-height:1.4;
    min-height:36px;min-width:220px;max-width:min(620px,100%);
    margin:16px 0 0 0;background:#fff;border:1px solid var(--orange);border-radius:5px;
    padding:8px 12px;cursor:grab;white-space:normal;overflow-wrap:anywhere;box-sizing:border-box
  }
  .answerSlot .placeholder{display:flex;align-items:center;gap:8px;opacity:.55}
  .answerSlot .placeholder svg{width:16px;height:16px}
  .answerSlot.empty{border-color:var(--orange)}
  .answerSlot.used{border-color:#000}
  .answerSlot.correct{border-color:var(--green)}
  .answerSlot.incorrect{border-color:var(--red)}

  /* Shelf */
  .bank{display:flex;flex-wrap:wrap;gap:10px;justify-content:flex-start;margin-top:20px}
  .slot{display:inline-block;vertical-align:top}
  .chip{
    min-width:var(--chip-min);height:26px;line-height:26px;padding:0 10px;box-sizing:border-box;display:inline-block;text-align:center;
    border:1px dashed #000;border-radius:5px;background:#fff;cursor:grab;font-size:12px;white-space:nowrap
  }
  .chip:hover{background:#f7f7f7}
  .chipWrong{border-color:var(--red)}

  /* Controls */
  .controls{display:flex;gap:20px;justify-content:flex-start;margin-top:30px;flex-wrap:wrap}
  .btn{width:87px;height:32px;border-radius:5px;border:1px solid #000;background:#fff;color:#000;font-weight:700;font-size:18px;cursor:pointer;transition:filter .15s,background .15s,transform .05s}
  .btn:not(.btnGreat):hover{background:#f7f7f7}
  .btn:not(.btnGreat):active{transform:scale(.98)}
  .btnCheck{background:#FF9700;border-color:#FF9700}
  .btnCheck:hover{filter:brightness(.95)}
  .btnGreat{width:131px;height:32px;background:#009901;border-color:#009901;color:#fff;font-weight:400;font-size:16px;pointer-events:none}
  .btnLink{
    width:313px;height:32px;background:#fff;border:1px solid #000;border-radius:5px;color:#000;font-size:16px;font-weight:400;
    text-decoration:none;display:inline-flex;align-items:center;justify-content:center;gap:8px;opacity:0;transform:translateX(12px)
  }
  .btnLink:hover{background:#f7f7f7}
  .hidden{display:none}

  /* Animations */
  @keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.05)}100%{transform:scale(1)}}
  @keyframes slideOutRight{to{transform:translateX(24px);opacity:0}}
  @keyframes slideInRight{from{transform:translateX(12px);opacity:0}to{transform:translateX(0);opacity:1}}
  .pulse{animation:pulse .6s ease-in-out 2}
  .slideOutRight{animation:slideOutRight .35s ease-out forwards}
  .slideInRight{animation:slideInRight .35s ease-out forwards}

  /* Background pulse on success */
  @keyframes bgPulse{0%{background:var(--light)}35%{background:#dff6e3}100%{background:var(--light)}}
  .bgPulse{animation:bgPulse .6s ease-out 1}

  /* Confetti */
  .confetti{position:fixed;left:50%;top:20%;width:6px;height:10px;background:#009901;border-radius:1px;opacity:.9;animation:fall .9s ease-out forwards}
  @keyframes fall{from{transform:translate(-50%,0) rotate(0)}to{transform:translate(calc(-50% + var(--dx)),120px) rotate(260deg);opacity:0}}

  /* ===== Responsive ===== */

  /* Desktop MCQ grid: responsive columns (min 280px) so long answers force >=2 columns */
  @media (min-width: 701px){
    .bank.mcq{
      display:grid; grid-template-columns:repeat(auto-fit, minmax(280px, 1fr));
      gap:14px 16px; align-items:start; justify-items:stretch;
    }
    .bank.mcq .slot{width:100%; min-height:42px}
    .bank.mcq .chip{
      display:block; width:100%; white-space:normal; text-align:left;
      padding:10px 12px; line-height:1.4; height:auto; box-sizing:border-box;
    }
  }

  /* Tablet/phone general tweaks */
  @media (max-width:820px){.wrap{padding:12px}#game{padding:22px}.previewBox{width:calc(100% - 48px)}.sentence{font-size:17px}.blank{min-width:96px}}
  @media (max-width:700px){
    /* MCQ: stacked, centered full-width chips */
    .bank.mcq{display:flex;flex-direction:column;align-items:center}
    .bank.mcq .slot{width:100%}
    .bank.mcq .chip{
      display:block; width:100%; max-width:100%; white-space:normal; overflow-wrap:anywhere;
      text-align:left; padding:10px 12px; line-height:1.4; height:auto;
    }
  }
  @media (max-width:560px){
    body{font-size:18px}
    #preplay{height:auto;padding-bottom:20px}
    .title24{font-size:22px}
    .previewBox{font-size:16px}
    .sentence{font-size:16px;line-height:30px}
    .blank{height:30px;line-height:30px;padding:0 10px;min-width:88px}
    .answerSlot{display:block;max-width:100%;width:100%}
    .bank{gap:8px}
    .chip{min-width:72px;font-size:11px;line-height:24px;height:24px;padding:0 8px}
    .controls{gap:12px}
    .btn,.btnCheck,.btnGreat,.btnLink{width:100%}
  }
  @media (max-width:360px){.sentence{font-size:15px}.blank{min-width:80px}}
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <section id="preplay">
        <div class="dateTop" id="dateTop">Loading…</div>
        <h1 class="title24">Today’s Physics Game</h1>
        <div class="previewBox" id="previewBox">Loading question…</div>
        <button class="btnPlay" id="playBtn">Play</button>
      </section>

      <section id="game">
        <div class="dateLeft" id="dateLeft">—</div>
        <div class="sentence" id="sentence"></div>

        <!-- MCQ answer slot mounts here -->
        <div id="mcqSlotHost"></div>

        <div class="bank" id="bank"></div>

        <div class="controls" id="controls">
          <button class="btn" id="resetBtn">Reset</button>
          <button class="btn btnCheck" id="checkBtn">Check</button>
          <button class="btn btnGreat hidden" id="greatBtn">Great Job!</button>
          <a class="btnLink hidden" id="learnBtn" target="_blank" rel="noopener">
            Learn more about this topic here
            <!-- Heroicons outline external-link -->
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                 width="18" height="18" stroke="currentColor" stroke-width="1.5" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round"
                    d="M13.5 6H5.25A2.25 2.25 0 0 0 3 8.25v10.5A2.25 2.25 0 0 0 5.25 21h10.5A2.25 2.25 0 0 0 18 18.75V10.5m-10.5 6L21 3m0 0h-5.25M21 3v5.25"/>
            </svg>
          </a>
        </div>
      </section>

      <section id="empty" class="hidden" style="padding:30px;text-align:center">No question found for today.</section>
    </div>
  </div>

<script>
/* ===== Config ===== */
const CONFIG={chipMinWidth:84,mobileDisableFixedSlotsAt:0}; // keep fixed slots for fill-blank
const CSV_URL="https://docs.google.com/spreadsheets/d/e/2PACX-1vSJlHGcShI4Ek9XrNBx_-xD7CT7uS2K2lhmzr1WU6z48u0xNcncL0RGfYFSzzPkTUZ-yurB7L0x7Szk/pub?gid=0&single=true&output=csv";
const F={date:"date",type:"type",q:"question",correct:"correct_words",distr:"distractors",link:"link"};
const TYPES={FILL:"fill_blank", MCQ:"multiple_choice"};
const TOTAL_OPTIONS_FILL=5;

/* ===== State ===== */
const S={mode:TYPES.FILL,q:"",correct:[],distr:[],blanks:0,placements:[],tokens:[],link:"",chipsMap:new Map(),slotIndexById:new Map(),slotText:[],mcq:{slot:null,selection:null}};
let chipSeq=0,_drag=null;

/* ===== Utils ===== */
function toYMD(tz="Europe/London",d=new Date()){
  const p=new Intl.DateTimeFormat('en-CA',{timeZone:tz,year:'numeric',month:'2-digit',day:'2-digit'}).formatToParts(d).filter(x=>x.type!=='literal').map(x=>x.value);
  return `${p[0]}-${p[1]}-${p[2]}`;
}
function ordinal(n){const s=["th","st","nd","rd"],v=n%100;return n+(s[(v-20)%10]||s[v]||s[0])}
function human(tz="Europe/London",d=new Date()){
  const parts=new Intl.DateTimeFormat('en-GB',{timeZone:tz,day:'numeric',month:'long',year:'numeric'}).formatToParts(d);
  const day=+parts.find(p=>p.type==='day').value, mon=parts.find(p=>p.type==='month').value, y=parts.find(p=>p.type==='year').value;
  return `${ordinal(day)} ${mon} ${y}`;
}
/* Pipe-delimited lists */
function splitListByPipe(s){return (s||"").split("|").map(x=>x.trim()).filter(Boolean)}
function $(q){return document.querySelector(q)}
function measureChipWidth(text){
  const tmp=document.createElement("span");
  tmp.className="chip"; tmp.style.position="absolute"; tmp.style.visibility="hidden"; tmp.style.left="-9999px";
  tmp.textContent=text; document.body.appendChild(tmp);
  const w=tmp.offsetWidth; document.body.removeChild(tmp); return w;
}
function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a}
function renderPreview(){
  if(S.mode===TYPES.FILL) $("#previewBox").textContent=S.q.replace(/\[blank\]/g,"______");
  else $("#previewBox").textContent=S.q;
}

/* ===== Fill-in blanks ===== */
function enableBlank(b){
  b.addEventListener("dragover",e=>e.preventDefault());
  b.addEventListener("drop",e=>{
    e.preventDefault();
    const idx=+b.dataset.index;
    const id=e.dataTransfer.getData("text/id");
    const word=e.dataTransfer.getData("text/label");
    if(!id) return;
    placeChipInBlank({id,word}, idx, true);
  });
  b.addEventListener("click",()=>{
    const idx=+b.dataset.index, placed=S.placements[idx];
    if(!placed) return;
    returnChipToBank(placed.id);
    S.placements[idx]=null; b.textContent=""; b.className="blank";
  });
  b.addEventListener("dragstart",e=>{
    if(!b.textContent.trim()) return;
    const idx=+b.dataset.index, placed=S.placements[idx]; if(!placed) return;
    _drag={from:"blank",idx,id:placed.id,word:placed.word};
    e.dataTransfer.setData("text/id",placed.id); e.dataTransfer.setData("text/label",placed.word);
  });
  b.draggable=true;
}
function renderSentence(){
  const host=$("#sentence"); host.innerHTML="";
  const parts=S.q.split("[blank]");
  parts.forEach((t,i)=>{
    host.append(document.createTextNode(t));
    if(i<parts.length-1){
      const sp=document.createElement("span"); sp.className="blank"; sp.dataset.index=i;
      enableBlank(sp); host.append(sp);
    }
  });
}
function placeChipInBlank(item, idx, fromDrag){
  if(S.placements[idx]) returnChipToBank(S.placements[idx].id);
  if(_drag && _drag.from==="blank"){
    const from=_drag.idx;
    if(from!==idx){
      S.placements[from]=null;
      const el=document.querySelector(`.blank[data-index="${from}"]`);
      el.textContent=""; el.className="blank";
    }
  }
  if((_drag && _drag.from==="bank") || !fromDrag){
    const node=S.chipsMap.get(item.id);
    if(node && node.parentElement) node.parentElement.removeChild(node);
  }
  S.placements[idx]={id:item.id,word:item.word};
  const target=document.querySelector(`.blank[data-index="${idx}"]`);
  target.textContent=item.word; target.className="blank used"; _drag=null;
  setSlotWidths();
}

/* ===== MCQ ===== */
function buildAnswerSlot(){
  const host=$("#mcqSlotHost"); host.innerHTML="";
  const slot=document.createElement("div");
  slot.className="answerSlot empty"; slot.id="answerSlot"; slot.draggable=true;

  const hint=document.createElementNS("http://www.w3.org/2000/svg","svg");
  hint.setAttribute("viewBox","0 0 24 24"); hint.setAttribute("width","16"); hint.setAttribute("height","16");
  hint.innerHTML='<path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>';
  const placeholder=document.createElement("span"); placeholder.className="placeholder";
  placeholder.appendChild(hint); placeholder.appendChild(document.createTextNode("Select or drag an answer"));
  slot.appendChild(placeholder);

  slot.addEventListener("dragstart",e=>{
    if(!S.mcq.selection) { e.preventDefault(); return; }
    _drag={from:"mcq",id:S.mcq.selection.id,word:S.mcq.selection.word};
    e.dataTransfer.setData("text/id",S.mcq.selection.id); e.dataTransfer.setData("text/label",S.mcq.selection.word);
  });
  slot.addEventListener("click",()=>{
    if(!S.mcq.selection) return;
    returnChipToBank(S.mcq.selection.id);
    S.mcq.selection=null;
    setAnswerSlot("");
  });
  slot.addEventListener("dragover",e=>e.preventDefault());
  slot.addEventListener("drop",e=>{
    e.preventDefault();
    const id=e.dataTransfer.getData("text/id");
    const word=e.dataTransfer.getData("text/label");
    if(!id) return;
    if(S.mcq.selection) returnChipToBank(S.mcq.selection.id);
    if(_drag && (_drag.from==="bank" || _drag.from==="blank" || _drag.from==="mcq")){
      const node=S.chipsMap.get(id);
      if(node && node.parentElement) node.parentElement.removeChild(node);
    }
    S.mcq.selection={id,word};
    setAnswerSlot(word, "used");
  });
  host.appendChild(slot);
  S.mcq.slot=slot;
}
function setAnswerSlot(text, stateClass){
  const slot=S.mcq.slot; if(!slot) return;
  slot.classList.remove("used","correct","incorrect","empty");
  if(!text){
    slot.textContent="";
    const placeholder=document.createElement("span"); placeholder.className="placeholder";
    const svg=document.createElementNS("http://www.w3.org/2000/svg","svg");
    svg.setAttribute("viewBox","0 0 24 24"); svg.setAttribute("width","16"); svg.setAttribute("height","16");
    svg.innerHTML='<path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>';
    placeholder.appendChild(svg); placeholder.appendChild(document.createTextNode("Select or drag an answer"));
    slot.appendChild(placeholder);
    slot.classList.add("empty");
  }else{
    slot.textContent=text;
    if(stateClass) slot.classList.add(stateClass);
  }
}

/* ===== Shelf (shared) ===== */
function makeChip(word){
  const id=`c${++chipSeq}`;
  const chip=document.createElement("span");
  chip.className="chip"; chip.textContent=word; chip.draggable=true; chip.dataset.id=id;
  chip.addEventListener("dragstart",e=>{
    _drag={from:"bank",id,word,node:chip};
    e.dataTransfer.setData("text/id",id); e.dataTransfer.setData("text/label",word);
  });
  chip.addEventListener("click",()=>{
    if(S.mode===TYPES.FILL){
      const nextIdx=S.placements.findIndex(x=>!x);
      if(nextIdx===-1) return;
      placeChipInBlank({id,word}, nextIdx, false);
    }else{
      if(S.mcq.selection){ returnChipToBank(S.mcq.selection.id); }
      const node=S.chipsMap.get(id);
      if(node && node.parentElement) node.parentElement.removeChild(node);
      S.mcq.selection={id,word};
      setAnswerSlot(word, "used");
    }
  });
  S.chipsMap.set(id,chip);
  return {id,node:chip,word};
}

function renderBank(){
  const bank=$("#bank"); bank.innerHTML="";
  bank.classList.toggle("mcq", S.mode===TYPES.MCQ);
  S.slotIndexById.clear(); S.slotText=[...S.tokens];
  S.tokens.forEach((tok, i)=>{
    const slot=document.createElement("div"); slot.className="slot"; slot.dataset.index=i;
    const {id,node}=makeChip(tok);
    slot.appendChild(node); bank.appendChild(slot);
    S.slotIndexById.set(id, i);
  });
  setSlotWidths();
}

/* For fill-blank we keep fixed “parking bays”.
   For MCQ: on desktop we let the grid handle layout; on small screens we disable widths. */
function setSlotWidths(){
  const bank=$("#bank"); if(!bank) return;
  const isMCQ = S.mode===TYPES.MCQ;
  const isSmall = window.innerWidth <= 700;

  if(isMCQ){
    // Grid (desktop) or stacked (mobile) — let CSS control widths
    [...bank.querySelectorAll(".slot")].forEach(slot=>{ slot.style.width=""; });
    return;
  }

  // Fill-blank fixed slots as before
  const disable = window.innerWidth <= CONFIG.mobileDisableFixedSlotsAt;
  const slots=[...bank.querySelectorAll(".slot")];
  if(disable){ slots.forEach(slot=>{ slot.style.width = ""; }); return; }
  slots.forEach((slot,i)=>{
    const txt=S.slotText[i] ?? "";
    const hasChip=slot.firstElementChild && slot.firstElementChild.classList.contains("chip");
    const w = hasChip ? slot.firstElementChild.offsetWidth : measureChipWidth(txt);
    slot.style.width = Math.max(CONFIG.chipMinWidth, w) + "px";
  });
}

function addChipToBankById(id){
  const slotIdx=S.slotIndexById.get(id);
  const chip=S.chipsMap.get(id);
  if(chip==null || slotIdx==null) return;
  const slot=$("#bank").querySelector(`.slot[data-index="${slotIdx}"]`);
  if(slot) slot.appendChild(chip);
  setSlotWidths();
}
function returnChipToBank(id){ addChipToBankById(id); }

/* Drop back onto shelf */
$("#bank").addEventListener("dragover",e=>e.preventDefault());
$("#bank").addEventListener("drop",e=>{
  e.preventDefault();
  if(_drag){
    if(S.mode===TYPES.FILL && _drag.from==="blank"){
      const from=_drag.idx; returnChipToBank(_drag.id); S.placements[from]=null;
      const el=document.querySelector(`.blank[data-index="${from}"]`); el.textContent=""; el.className="blank"; _drag=null;
    }else if(S.mode===TYPES.MCQ && _drag.from==="mcq"){
      returnChipToBank(_drag.id);
      S.mcq.selection=null;
      setAnswerSlot("");
      _drag=null;
    }
  }
});

/* Reset */
function resetGame(){
  $("#preplay").style.display="block";
  $("#game").style.display="none";
  $("#empty").classList.add("hidden");

  const check=$("#checkBtn");
  check.classList.remove("hidden","slideOutRight","pulse");
  check.style.opacity=""; check.style.transform="";

  const great=$("#greatBtn");
  great.classList.add("hidden"); great.classList.remove("pulse");

  const a=$("#learnBtn");
  a.classList.add("hidden"); a.classList.remove("slideInRight");
  a.style.opacity=0; a.style.transform="translateX(12px)";

  if(S.mode===TYPES.FILL){
    S.placements=Array(S.blanks).fill(null);
    document.querySelectorAll(".blank").forEach(b=>{ b.textContent=""; b.className="blank"; });
  }else{
    S.mcq.selection=null;
    setAnswerSlot("");
  }
  $("#bank").querySelectorAll(".chip").forEach(ch=>ch.classList.remove("chipWrong"));
  renderPreview();
}
$("#resetBtn").onclick=resetGame;

/* Success & Check */
function celebrate(){
  for(let i=0;i<18;i++){
    const c=document.createElement("div");
    c.className="confetti";
    c.style.setProperty("--dx",`${(Math.random()*240-120)|0}px`);
    document.body.appendChild(c);
    setTimeout(()=>c.remove(),950);
  }
}
function onSuccess(){
  const card=document.querySelector(".card");
  card.classList.remove("bgPulse"); void card.offsetWidth; card.classList.add("bgPulse");

  const btn=$("#checkBtn");
  btn.classList.add("pulse");
  celebrate();
  setTimeout(()=>{
    btn.classList.add("slideOutRight");
    setTimeout(()=>{
      btn.classList.add("hidden");
      $("#greatBtn").classList.remove("hidden"); $("#greatBtn").classList.add("pulse");
      if(S.link){
        const a=$("#learnBtn"); a.href=S.link; a.classList.remove("hidden");
        setTimeout(()=>{ a.classList.add("slideInRight"); a.style.opacity=1; }, 900);
      }
      $("#bank").querySelectorAll(".chip").forEach(ch=>ch.classList.add("chipWrong"));
    },350);
  },620);
}

$("#checkBtn").onclick=()=>{
  if(S.mode===TYPES.FILL){
    let all=true;
    document.querySelectorAll(".blank").forEach((b,i)=>{
      const placed=S.placements[i], ok=placed && placed.word===S.correct[i];
      b.classList.remove("used","correct","incorrect");
      if(placed){ b.classList.add(ok?"correct":"incorrect"); b.textContent=placed.word; }
      else all=false;
      if(!ok) all=false;
    });
    if(all) onSuccess();
  }else{
    const slot=S.mcq.slot;
    const sel=S.mcq.selection;
    let correct=false;
    if(sel){
      correct = sel.word === (S.correct[0]||"");
      slot.classList.remove("used","correct","incorrect","empty");
      slot.classList.add(correct?"correct":"incorrect");
    }
    if(correct) onSuccess();
  }
};

$("#greatBtn").onclick=()=>{};

/* Play & Init */
$("#playBtn").onclick=()=>{
  $("#preplay").style.display="none"; $("#game").style.display="block";
  $("#dateLeft").textContent=$("#dateTop").textContent;

  if(S.mode===TYPES.FILL){
    renderSentence();
    S.placements=Array(S.blanks).fill(null);
    renderBank(); setSlotWidths();
  }else{
    $("#sentence").textContent=S.q;
    buildAnswerSlot();
    renderBank(); setSlotWidths();
  }
};

function choose(rows,ymd){const url=new URL(location.href);const o=url.searchParams.get("date")||ymd;return rows.find(r=>(r[F.date]||"").trim()===o)}

(async function init(){
  const today=toYMD("Europe/London"), humanStr=human("Europe/London");
  $("#dateTop").textContent=humanStr; $("#dateLeft").textContent=humanStr;

  const csv=await fetch(CSV_URL,{cache:"no-store"}).then(r=>r.text());
  const parsed=Papa.parse(csv,{header:true,skipEmptyLines:true});
  const row=choose(parsed.data,today);

  if(!row){ $("#preplay").style.display="none"; $("#empty").classList.remove("hidden"); return }

  S.mode = ((row[F.type]||"").trim()===TYPES.MCQ) ? TYPES.MCQ : TYPES.FILL;
  S.q=(row[F.q]||"").trim();
  S.correct=splitListByPipe(row[F.correct]);
  S.distr=splitListByPipe(row[F.distr]);
  S.link=(row[F.link]||"").trim();

  if(S.mode===TYPES.FILL){
    S.blanks=(S.q.match(/\[blank\]/g)||[]).length;
    if(S.blanks!==S.correct.length){ $("#preplay").style.display="none"; $("#empty").classList.remove("hidden"); $("#empty").textContent="Config error: [blank] count must equal correct_words."; return }
    S.tokens=[...S.correct, ...S.distr.slice(0, Math.max(0, TOTAL_OPTIONS_FILL - S.correct.length))];
  }else{
    S.blanks=1;
    S.tokens=[...S.correct, ...S.distr];
  }

  S.tokens=shuffle(S.tokens);
  S.placements=Array(S.mode===TYPES.FILL ? S.blanks : 1).fill(null);
  S.mcq.selection=null;
  renderPreview();

  let resizeTO=null;
  window.addEventListener('resize', ()=>{ clearTimeout(resizeTO); resizeTO=setTimeout(setSlotWidths, 120); });
})();
</script>
</body>
</html>
