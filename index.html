<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Today’s Physics Game</title>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<style>
  /* BRAND */
  :root{
    --green:#009901;
    --red:#FF0000;
    --light:#F0F0F0;
    --orange:#FF9700;
    --ink:#111;
    --muted:#666;
  }
  html,body{margin:0;background:#fff;color:var(--ink);}
  body{font-family:"Century Gothic","Segoe UI",Arial,sans-serif;font-size:20px;line-height:1.5;}

  /* CANVAS */
  .wrap{max-width:940px;margin:0 auto;padding:24px 0;display:flex;justify-content:center}
  .card{
    width:760px; /* frame width */
    background:var(--light);
    border:2px solid var(--orange);
    border-radius:20px;
    box-sizing:border-box;
    position:relative;
  }

  /* FRAME 1 (pre-play) */
  #preplay{height:260px; /* frame 1 height */ text-align:center; position:relative;}
  .dateTop{font-size:12px;margin-top:30px;margin-bottom:5px;color:#000}
  .title24{font-weight:700;font-size:24px;margin:0}
  .previewBox{
    width:calc(100% - 80px); /* 40px side padding each */
    margin:30px auto 0 auto;
    background:#fff;border-radius:20px;padding:20px;box-sizing:border-box;
    font-size:18px;
  }
  .btnPlay{
    width:87px;height:36px;line-height:36px;margin:30px auto 0 auto;
    background:var(--orange); color:#000; border-radius:8px; /* rounded feel; image shows >5 */
    display:block; font-weight:700; font-size:18px; border:0; cursor:pointer;
  }

  /* FRAMES 2–5 (in-game) */
  #game{padding:30px 30px 30px 30px; display:none;}
  .dateLeft{font-size:12px; margin-left:0; color:#000}
  .rowGap20{margin-top:20px}
  .sentence{font-size:18px; text-align:left}
  .blank{
    display:inline-flex; width:118px; height:32px; box-sizing:border-box;
    border:1px solid var(--orange); border-radius:8px; background:#fff;
    vertical-align:middle; align-items:center; justify-content:center;
    margin:0 4px 6px 4px; padding:0 8px; cursor:grab;
  }
  .blank.used{border-color:#000;}              /* frame 3 before check */
  .blank.correct{border-color:var(--green);}   /* frame 4/5 */
  .blank.incorrect{border-color:var(--red);}   /* frame 4 */
  .bank{display:flex;flex-wrap:wrap;gap:10px;justify-content:flex-start;margin-top:20px}
  .chip{
    min-width:84px; height:26px; box-sizing:border-box;
    padding:0 10px; display:inline-flex; align-items:center; justify-content:center;
    border:1px dashed #000; border-radius:8px; background:#fff; cursor:grab;
    font-size:12px; line-height:12px;
  }
  .controls{display:flex;gap:20px;justify-content:flex-start;margin-top:30px}
  .btn{width:87px;height:32px;border-radius:8px;border:1px solid #000;background:#fff;color:#000;font-weight:700;font-size:18px;cursor:pointer}
  .btnCheck{background:var(--orange);border-color:var(--orange)}
  .btnGreat{width:131px;height:32px;background:var(--green);border-color:var(--green);color:#fff;font-weight:400;font-size:16px}
  .btnLink{width:313px;height:32px;background:#fff;border:1px solid #000;border-radius:8px;color:#000;font-size:16px;font-weight:400;text-decoration:none;display:inline-flex;align-items:center;justify-content:center}
  .hidden{display:none}

  /* Confetti */
  .confetti{position:fixed;left:50%;top:20%;width:6px;height:10px;background:var(--green);border-radius:1px;opacity:.9;animation:fall .9s ease-out forwards}
  @keyframes fall{from{transform:translate(-50%,0) rotate(0)}to{transform:translate(calc(-50% + var(--dx)),120px) rotate(260deg);opacity:0}}
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">

      <!-- FRAME 1 -->
      <section id="preplay">
        <div class="dateTop" id="dateTop">Loading…</div>
        <h1 class="title24">Today’s Physics Game</h1>
        <div class="previewBox" id="previewBox">Loading question…</div>
        <button class="btnPlay" id="playBtn">Play</button>
      </section>

      <!-- FRAMES 2–5 -->
      <section id="game">
        <div class="dateLeft" id="dateLeft">—</div>
        <div class="rowGap20 sentence" id="sentence"></div>

        <div class="bank" id="bank"></div>

        <div class="controls" id="controls">
          <button class="btn" id="resetBtn">Reset</button>
          <button class="btn btnCheck" id="checkBtn">Check</button>
          <button class="btn btnGreat hidden" id="greatBtn">Great Job!</button>
          <a class="btnLink hidden" id="learnBtn" target="_blank" rel="noopener">Learn more about this topic here</a>
        </div>
      </section>

      <section id="empty" class="hidden" style="padding:30px;text-align:center">No question found for today.</section>
    </div>
  </div>

<script>
/* CONFIG */
const CSV_URL="https://docs.google.com/spreadsheets/d/e/2PACX-1vSJlHGcShI4Ek9XrNBx_-xD7CT7uS2K2lhmzr1WU6z48u0xNcncL0RGfYFSzzPkTUZ-yurB7L0x7Szk/pub?gid=0&single=true&output=csv";
const F={date:"date",type:"type",q:"question",correct:"correct_words",distr:"distractors",link:"link"};
const EXPECTED="fill_blank";
const TOTAL_OPTIONS=5;

/* STATE */
const S={q:"",correct:[],distr:[],blanks:0,placements:[],tokens:[],link:""};

/* Utils */
function toYMD(tz="Europe/London",d=new Date()){
  const p=new Intl.DateTimeFormat('en-CA',{timeZone:tz,year:'numeric',month:'2-digit',day:'2-digit'}).formatToParts(d).filter(x=>x.type!=='literal').map(x=>x.value);
  return `${p[0]}-${p[1]}-${p[2]}`;
}
function ordinal(n){const s=["th","st","nd","rd"],v=n%100;return n+(s[(v-20)%10]||s[v]||s[0]);}
function human(tz="Europe/London",d=new Date()){
  const parts=new Intl.DateTimeFormat('en-GB',{timeZone:tz,day:'numeric',month:'long',year:'numeric'}).formatToParts(d);
  const day=+parts.find(p=>p.type==='day').value;
  const mon=parts.find(p=>p.type==='month').value;
  const y=parts.find(p=>p.type==='year').value;
  return `${ordinal(day)} ${mon} ${y}`;
}
function splitList(s){return (s||"").split(",").map(x=>x.trim()).filter(Boolean)}
function $(q){return document.querySelector(q)}
function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a}

/* Build */
function renderPreview(){
  $("#previewBox").textContent=S.q.replace(/\[blank\]/g,"______");
}
function enableBlank(b){
  b.addEventListener("dragover",e=>e.preventDefault());
  b.addEventListener("drop",e=>{
    e.preventDefault();
    const idx=+b.dataset.index;
    const word=e.dataTransfer.getData("text/plain");
    // clear old
    if(S.placements[idx]) addChip(S.placements[idx]);
    // if dragged from another blank, clear that
    if(window._drag && _drag.from==="blank"){
      const from=_drag.idx;
      if(from!==idx){
        S.placements[from]=null;
        const el=document.querySelector(`.blank[data-index="${from}"]`);
        el.textContent=""; el.classList.remove("used","correct","incorrect");
      }
    }
    // if from bank, remove chip node
    if(window._drag && _drag.from==="bank") _drag.node.remove();

    S.placements[idx]=word;
    b.textContent=word;
    b.classList.add("used"); b.classList.remove("correct","incorrect");
    _drag=null;
  });
  b.addEventListener("dragstart",e=>{
    if(b.textContent.trim()){
      _drag={from:"blank",idx:+b.dataset.index,word:b.textContent.trim()};
      e.dataTransfer.setData("text/plain",_drag.word);
    }
  });
  b.draggable=true;
}
function renderSentence(){
  const host=$("#sentence"); host.innerHTML="";
  const parts=S.q.split("[blank]");
  parts.forEach((t,i)=>{
    host.append(document.createTextNode(t));
    if(i<parts.length-1){
      const sp=document.createElement("span");
      sp.className="blank"; sp.dataset.index=i;
      enableBlank(sp); host.append(sp);
    }
  });
}
function addChip(w){
  const chip=document.createElement("span");
  chip.className="chip"; chip.textContent=w; chip.draggable=true;
  chip.addEventListener("dragstart",e=>{
    _drag={from:"bank",node:chip,word:w};
    e.dataTransfer.setData("text/plain",w);
  });
  $("#bank").append(chip);
}
function renderBank(){
  $("#bank").innerHTML="";
  S.tokens.forEach(addChip);
}
function resetToFrame1(){
  // clear game
  $("#game").style.display="none";
  $("#preplay").style.display="block";
  // reset placements for next play
  S.placements=Array(S.blanks).fill(null);
  // restore preview text
  renderPreview();
  // buttons back
  $("#checkBtn").classList.remove("hidden");
  $("#greatBtn").classList.add("hidden");
  $("#learnBtn").classList.add("hidden");
}
function resetInGame(){
  S.placements=Array(S.blanks).fill(null);
  document.querySelectorAll(".blank").forEach(b=>{b.textContent=""; b.className="blank";});
  renderBank();
}

/* Interactions */
let _drag=null;
$("#bank").addEventListener("dragover",e=>e.preventDefault());
$("#bank").addEventListener("drop",e=>{
  e.preventDefault();
  if(_drag && _drag.from==="blank"){
    const from=_drag.idx; addChip(_drag.word);
    S.placements[from]=null;
    const el=document.querySelector(`.blank[data-index="${from}"]`);
    el.textContent=""; el.className="blank";
    _drag=null;
  }
});

$("#resetBtn").onclick=resetToFrame1;

$("#checkBtn").onclick=()=>{
  let all=true;
  document.querySelectorAll(".blank").forEach((b,i)=>{
    const placed=S.placements[i];
    const ok=placed && placed===S.correct[i];
    b.classList.remove("used","correct","incorrect");
    if(placed){ b.classList.add(ok?"correct":"incorrect"); }
    else all=false;
    if(!ok) all=false;
  });
  if(all){
    $("#checkBtn").classList.add("hidden");
    $("#greatBtn").classList.remove("hidden");
    if(S.link){ const a=$("#learnBtn"); a.href=S.link; a.classList.remove("hidden"); }
    for(let i=0;i<18;i++){const c=document.createElement("div");c.className="confetti";c.style.setProperty("--dx",`${(Math.random()*240-120)|0}px`);document.body.appendChild(c);setTimeout(()=>c.remove(),950);}
  }
};

$("#greatBtn").onclick=()=>{}; // no-op (could advance to tomorrow etc.)

$("#playBtn").onclick=()=>{
  $("#preplay").style.display="none";
  $("#game").style.display="block";
  $("#dateLeft").textContent=$("#dateTop").textContent;
  renderSentence();
  renderBank();
};

/* Data */
function choose(rows,ymd){
  const url=new URL(location.href);const o=url.searchParams.get("date")||ymd;
  return rows.find(r=>(r[F.date]||"").trim()===o);
}
(async function init(){
  const today=toYMD("Europe/London"); const humanStr=human("Europe/London");
  $("#dateTop").textContent=humanStr; $("#dateLeft").textContent=humanStr;

  const csv=await fetch(CSV_URL,{cache:"no-store"}).then(r=>r.text());
  const parsed=Papa.parse(csv,{header:true,skipEmptyLines:true});
  const row=choose(parsed.data,today);

  if(!row || (row[F.type]||"").trim()!==EXPECTED){ $("#preplay").style.display="none"; $("#empty").classList.remove("hidden"); return; }

  S.q=(row[F.q]||"").trim();
  S.correct=splitList(row[F.correct]);
  S.distr=splitList(row[F.distr]);
  S.link=(row[F.link]||"").trim();
  S.blanks=(S.q.match(/\[blank\]/g)||[]).length;

  if(S.blanks!==S.correct.length){ $("#preplay").style.display="none"; $("#empty").classList.remove("hidden"); $("#empty").textContent="Config error: [blank] count must equal correct_words."; return; }

  S.tokens=[...S.correct, ...S.distr.slice(0, Math.max(0, TOTAL_OPTIONS - S.correct.length))];
  S.tokens=shuffle(S.tokens);
  S.placements=Array(S.blanks).fill(null);

  renderPreview();
})();
</script>
</body>
</html>
